<!DOCTYPE html>
<html lang="en" class="transition-colors duration-300">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/main.css" />
    <title>Med Reminder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      .swipe-wrapper li,
      .swipe-wrapper button {
        transition: transform 0.3s ease;
        will-change: transform;
      }
      .pressed-effect:active {
        transform: scale(0.97);
        opacity: 0.85;
        transition: transform 0.1s, opacity 0.1s;
      }
      /* Pressed effect for all buttons except navigation buttons (.nav-btn) */
      button:not(.nav-btn):active {
        transform: scale(0.97);
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.25);
        transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
      }
      /* Enhanced interactive shadow effect for all buttons except .nav-btn */
      button:not(.nav-btn) {
        box-shadow: 0 4px #999;
      }
      button:not(.nav-btn):hover {
        box-shadow: 0 6px #777;
      }
      button:not(.nav-btn):active {
        transform: translateY(2px);
        box-shadow: 0 2px #777;
      }
      /* Navigation button ripple effect base styles */
      .nav-btn {
        position: relative;
        overflow: hidden;
      }
      .nav-btn::after {
        content: "";
        background: #f1f1f1;
        display: block;
        position: absolute;
        padding-top: 300%;
        padding-left: 350%;
        margin-left: -20px !important;
        margin-top: -120%;
        opacity: 0;
        transition: all 0.8s;
        pointer-events: none;
        border-radius: 50%;
      }
      .nav-btn:active::after {
        padding: 0;
        margin: 0;
        opacity: 1;
        transition: 0s;
      }
    </style>
    <link rel="stylesheet" href="/src/main.css" />
    <script>
      // Auto-set current date and time
      document.addEventListener("DOMContentLoaded", () => {
        const dateInput = document.getElementById("date-input");
        const timeInput = document.getElementById("time-input");

        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");
        const hh = String(now.getHours()).padStart(2, "0");
        const mi = String(now.getMinutes()).padStart(2, "0");

        dateInput.value = `${yyyy}-${mm}-${dd}`;
        timeInput.value = `${hh}:${mi}`;
      });
      tailwind.config = {
        darkMode: "class",
      };
    </script>
  </head>
  <body
    class="min-h-screen font-[Poppins] bg-gray-100 text-gray-800 dark:bg-[#121212] dark:text-gray-200 transition-colors duration-300"
  >
    <!-- Navigation Bar -->
    <nav class="sticky top-0 z-50 bg-white dark:bg-gray-900 p-5 shadow-md">
      <div class="flex items-center justify-between">
        <h1 class="text-xl font-bold text-red-600">Med Reminder</h1>

        <!-- Hamburger Button -->
        <button
          id="menu-toggle"
          class="md:hidden text-[#153677] dark:text-white focus:outline-none"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4 6h16M4 12h16M4 18h16"
            ></path>
          </svg>
        </button>

        <!-- Desktop Menu -->
        <ul class="hidden md:flex gap-5 list-none items-center">
          <li>
            <a
              onclick="navigateToSection('home')"
              class="font-bold text-[#153677] dark:text-white"
              >Home</a
            >
          </li>
          <li>
            <a
              href="#"
              onclick="navigateToSection('history'); return false;"
              class="font-bold text-[#153677] dark:text-white"
              >History</a
            >
          </li>
          <li>
            <a
              href="#settings"
              onclick="navigateToSection('settings')"
              class="font-bold text-[#153677] dark:text-white"
            >
              Settings
            </a>
          </li>
          <li>
            <button
              id="theme-toggle"
              class="rounded bg-[#ff5945] px-4 py-2 text-white hover:bg-[#e0523f] transition"
            >
              Toggle Theme
            </button>
          </li>
        </ul>
      </div>

      <!-- Mobile Nav Items -->
      <ul
        id="mobile-menu"
        class="hidden md:hidden mt-2 space-y-2 text-[#153677] dark:text-white"
      >
        <li>
          <a onclick="navigateToSection('home')" class="block px-2 py-1"
            >Home</a
          >
        </li>
        <li>
          <a
            href="#"
            onclick="navigateToSection('history'); return false;"
            class="block px-2 py-1"
            >History</a
          >
        </li>
        <li>
          <a
            href="#settings"
            onclick="navigateToSection('settings')"
            class="block px-2 py-1"
            >Settings</a
          >
        </li>
        <li>
          <button
            id="theme-toggle-mobile"
            class="w-full text-left rounded bg-[#ff5945] px-4 py-2 text-white"
          >
            Toggle Theme
          </button>
        </li>
      </ul>
    </nav>

    <!-- Add Reminder Section -->
    <div class="p-5" id="home">
      <div
        class="mx-auto max-w-2xl rounded-xl bg-white dark:bg-gray-800 p-8 shadow-md"
      >
        <h2
          class="mb-5 text-center text-2xl font-semibold text-[#153677] dark:text-white"
        >
          Add Medicine Reminder
        </h2>

        <div class="flex flex-wrap gap-3">
          <!-- Medicine Name -->
          <div class="flex flex-col flex-1 min-w-[140px]">
            <label
              for="input-box"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Medicine Name</label
            >
            <input
              type="text"
              id="input-box"
              placeholder="Enter your medicine"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            />
          </div>

          <!-- Frequency -->
          <div class="flex flex-col flex-1 min-w-[140px]">
            <label
              for="frequency-input"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Frequency</label
            >
            <select
              id="frequency-input"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            >
              <option value="everyday">Every Day</option>
              <option value="alternate">Every Alternate Day</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
          </div>

          <!-- Day of Week for Weekly Frequency -->
          <div
            class="flex flex-col flex-1 min-w-[140px]"
            id="weekday-wrapper"
            style="display: none"
          >
            <label
              for="weekday-input"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Day of Week</label
            >
            <select
              id="weekday-input"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            >
              <option value="Sunday">Sunday</option>
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
              <option value="Saturday">Saturday</option>
            </select>
          </div>

          <!-- Date -->
          <div class="flex flex-col flex-1 min-w-[140px]" id="date-wrapper">
            <label
              for="date-input"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Date</label
            >
            <input
              type="date"
              id="date-input"
              placeholder="Select date"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            />
          </div>

          <!-- Time -->
          <div class="flex flex-col flex-1 min-w-[140px]">
            <label
              for="time-input"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Time</label
            >
            <input
              type="time"
              id="time-input"
              placeholder="Select time"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            />
          </div>

          <!-- Dosage -->
          <div class="flex flex-col flex-1 min-w-[140px]">
            <label
              for="dosage-input"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Dosage</label
            >
            <input
              type="number"
              id="dosage-input"
              placeholder="Dosage"
              inputmode="numeric"
              pattern="[0-9]*"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            />
          </div>

          <!-- Stock -->
          <div class="flex flex-col flex-1 min-w-[140px]">
            <label
              for="stock-input"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Stock</label
            >
            <input
              type="number"
              id="stock-input"
              placeholder="Stock"
              inputmode="numeric"
              pattern="[0-9]*"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            />
          </div>

          <!-- Note -->
          <div class="flex flex-col flex-1 min-w-[140px]">
            <label
              for="note-input"
              class="text-sm mb-1 text-gray-600 dark:text-gray-300"
              >Note (optional)</label
            >
            <input
              type="text"
              id="note-input"
              placeholder="Note"
              class="rounded border border-gray-300 p-2 text-black dark:text-white dark:bg-gray-700 dark:border-gray-600"
            />
          </div>

          <!-- Add Button -->
          <div class="flex items-end">
            <button
              id="add-button"
              class="rounded bg-[#ff5945] px-6 py-2 text-white hover:bg-[#e0523f] transition mt-6 pressed-effect"
            >
              Add
            </button>
          </div>
        </div>

        <ul id="lc" class="mt-6 space-y-2"></ul>
      </div>
    </div>

    <!-- History Log -->
    <div class="hidden p-5" id="history">
      <h2 class="mb-4 text-center text-2xl text-gray-800 dark:text-white">
        Medication History
      </h2>
      <div id="history-log" class="space-y-2">
        <div
          class="mx-auto max-w-2xl rounded-xl bg-white dark:bg-gray-800 p-4 shadow-md overflow-x-auto"
        >
          <table
            class="min-w-full table-auto text-sm text-left text-gray-800 dark:text-white"
          >
            <thead>
              <tr class="border-b border-gray-200 dark:border-gray-600">
                <th class="px-3 py-2 whitespace-nowrap"></th>
                <th class="px-3 py-2 whitespace-nowrap">Date</th>
                <th class="px-3 py-2 whitespace-nowrap">Medicine</th>
                <th class="px-3 py-2 whitespace-nowrap">Dosage</th>
                <th class="px-3 py-2 whitespace-nowrap">Stock Left</th>
              </tr>
            </thead>
            <tbody id="historyList"></tbody>
          </table>
          <div class="mt-4 flex justify-end">
            <button
              id="toggle-delete-mode"
              class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 pressed-effect"
            >
              Delete Selected
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Page -->
    <div class="hidden p-5" id="settings">
      <div class="flex flex-col lg:flex-row gap-4 max-w-7xl mx-auto">
        <!-- Sidebar -->
        <aside
          class="w-full lg:w-1/4 bg-white dark:bg-gray-800 p-4 rounded shadow"
        >
          <h3 class="text-lg font-semibold mb-4">Settings</h3>
          <ul class="space-y-3 text-sm">
            <li>
              <button
                id="my-profile-btn"
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 bg-blue-100 text-blue-700 font-medium pressed-effect"
                onclick="loadSettingsContent('profile')"
              >
                My Profile
              </button>
            </li>
            <li>
              <button
                id="security-options-btn"
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 pressed-effect"
                onclick="loadSettingsContent('security')"
              >
                Security Options
              </button>
            </li>
            <li>
              <button
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 pressed-effect"
              >
                Chat
              </button>
            </li>
            <li>
              <button
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 pressed-effect"
              >
                Preferences
              </button>
            </li>
            <li>
              <button
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 pressed-effect"
              >
                Notifications
              </button>
            </li>
            <li>
              <button
                id="login-btn"
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 pressed-effect"
              >
                Login
              </button>
            </li>
            <li>
              <button
                id="sign-up-btn"
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 pressed-effect"
              >
                Sign Up
              </button>
            </li>
            <li>
              <button
                id="logout-btn"
                class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-red-600 pressed-effect"
              >
                Logout
              </button>
            </li>
          </ul>
        </aside>

        <!-- Dynamic Content Area -->
        <section id="settings-content" class="w-full lg:w-3/4 bg-white dark:bg-gray-800 p-4 rounded shadow space-y-6">
          <!-- This will be populated dynamically -->
        </section>
    <!-- Profile and Security Templates -->
    <template id="profile-template">
      <div>
        <h2 class="text-xl font-semibold mb-2">Profile Information</h2>
        <div class="flex items-center gap-4 mb-4">
          <label for="profile-image-upload">
            <img
              id="profile-pic"
              class="h-20 w-20 rounded-full"
              src=""
              alt="Profile Image"
            />
          </label>
          <input
            id="profile-image-upload"
            type="file"
            accept="image/*"
            class="mt-2 hidden"
          />
          <div id="profile-info" class="hidden">
            <p class="font-semibold" id="profile-name"></p>
          </div>
          <button
            class="ml-auto px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm pressed-effect"
          >
            Edit
          </button>
        </div>
      </div>
      <div>
        <h3 class="text-lg font-semibold mb-2">Personal Details</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <input
            type="text"
            placeholder="First Name"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <input
            type="text"
            placeholder="Last Name"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <input
            type="email"
            placeholder="Email"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <input
            type="text"
            placeholder="Phone"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <input
            type="text"
            placeholder="Bio (optional)"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <select
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            id="gender-select"
          >
            <option value="" disabled selected>Select Gender</option>
            <option value="male">Male</option>
            <option value="female">Female</option>
            <option value="na">Prefer not to say</option>
          </select>
          <input
            type="date"
            placeholder="DOB"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <select
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            id="nationality-select"
          >
            <option value="" disabled selected>Select Nationality</option>
            <option value="Indian">Indian</option>
            <option value="American">American</option>
            <option value="British">British</option>
            <option value="Canadian">Canadian</option>
            <option value="Australian">Australian</option>
            <option value="German">German</option>
            <option value="French">French</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>
      <div>
        <h3 class="text-lg font-semibold mb-2">Address</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <input
            type="text"
            placeholder="Country"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <input
            type="text"
            placeholder="City/State"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
          <input
            type="text"
            placeholder="Postal Code"
            class="p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            disabled
          />
        </div>
      </div>
      <div class="flex justify-end">
        <button
          id="save-profile"
          class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition pressed-effect"
        >
          Save
        </button>
      </div>
    </template>
    <template id="security-template">
      <section id="security-settings" class="mt-8">
        <h2 class="text-xl font-semibold mb-4">Security Settings</h2>
        <div class="mb-4">
          <label for="new-password" class="block font-medium mb-1"
            >Change Password:</label
          >
          <input
            type="password"
            id="new-password"
            class="border px-2 py-1 rounded w-full max-w-xs"
          />
          <button
            onclick="changePassword()"
            class="ml-2 px-3 py-1 bg-blue-600 text-white rounded"
          >
            Update
          </button>
        </div>
        <div class="mb-4">
          <label class="block font-medium mb-1">Password Strength:</label>
          <progress
            id="pwd-strength"
            max="100"
            value="0"
            class="w-full max-w-xs"
          ></progress>
        </div>
        <div class="mb-4">
          <label for="logout-time" class="block font-medium mb-1"
            >Auto Logout Timer (min):</label
          >
          <select
            id="logout-time"
            onchange="setAutoLogout()"
            class="border px-2 py-1 rounded text-black dark:text-white bg-white dark:bg-gray-700"
          >
            <option value="0">Off</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="15">15</option>
          </select>
        </div>
        <div class="mb-4">
          <label
            ><input type="checkbox" id="session-lock" /> Enable Session
            Lock</label
          >
        </div>
        <div class="mb-4">
          <p>Last Login: <span id="last-login" class="font-mono"></span></p>
          <p>
            Last Password Change:
            <span id="last-pwd-change" class="font-mono"></span>
          </p>
        </div>
        <div class="mb-4">
          <label
            ><input type="checkbox" id="trust-device" /> Remember this
            device</label
          >
        </div>
        <div class="mb-4">
          <button
            onclick="exportData()"
            class="px-3 py-1 bg-green-600 text-white rounded"
          >
            Export Backup
          </button>
          <input
            type="file"
            id="import-file"
            onchange="importData(event)"
            class="ml-2"
          />
        </div>
      </section>
    </template>
    <!-- Dynamic Settings Content Loader -->
    <script>
      // Shared utility function to highlight the clicked sidebar/settings button
      function highlightButton(currentBtn) {
        const sidebarBtnIds = [
          "my-profile-btn",
          "security-options-btn",
          "sign-up-btn",
          "login-btn",
          "logout-btn",
          "chat-btn",
          "preferences-btn",
          "notifications-btn"
        ];
        sidebarBtnIds.forEach(id => {
          const btn = document.getElementById(id);
          if (btn) {
            btn.classList.remove("active", "bg-blue-100", "text-blue-700");
          }
        });
        if (currentBtn) {
          currentBtn.classList.add("active", "bg-blue-100", "text-blue-700");
        }
      }

      function loadSettingsContent(view) {
        const contentContainer = document.getElementById("settings-content");
        if (!contentContainer) return;

        if (view === "profile") {
          highlightButton(document.getElementById("my-profile-btn"));
          contentContainer.innerHTML = document.getElementById("profile-template").innerHTML;
        } else if (view === "security") {
          highlightButton(document.getElementById("security-options-btn"));
          contentContainer.innerHTML = document.getElementById("security-template").innerHTML;
        } else if (view === "signup") {
          highlightButton(document.getElementById("sign-up-btn"));
          contentContainer.innerHTML = document.getElementById("signup-template").innerHTML;
        } else if (view === "login") {
          highlightButton(document.getElementById("login-btn"));
          // You can load login template here if needed
        } else if (view === "logout") {
          highlightButton(document.getElementById("logout-btn"));
          // You can handle logout logic here if needed
        }
        else {
          contentContainer.innerHTML = "<p class='text-center text-gray-500'>Select a section to view.</p>";
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadSettingsContent('profile');
        // Attach highlightButton listeners for new sidebar buttons if present
        document.getElementById("chat-btn")?.addEventListener("click", function () {
          highlightButton(this);
        });
        document.getElementById("preferences-btn")?.addEventListener("click", function () {
          highlightButton(this);
        });
        document.getElementById("notifications-btn")?.addEventListener("click", function () {
          highlightButton(this);
        });
      });
    </script>

        <script>
          // --- Begin: Security Settings JS ---
          function changePassword() {
            const pwd = document.getElementById("new-password").value;
            localStorage.setItem("userPassword", pwd);
            const now = new Date().toLocaleString();
            localStorage.setItem("lastPwdChange", now);
            alert("Password updated");
          }

          function setAutoLogout() {
            const mins = parseInt(document.getElementById("logout-time").value);
            if (mins > 0) {
              setTimeout(() => {
                alert("Session expired. Logging out.");
                window.location.reload();
              }, mins * 60000);
            }
          }

          function exportData() {
            const data = JSON.stringify(localStorage);
            const blob = new Blob([data], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "medreminder_backup.json";
            a.click();
          }

          function importData(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = () => {
              const data = JSON.parse(reader.result);
              for (let key in data) {
                localStorage.setItem(key, data[key]);
              }
              alert("Data imported!");
              location.reload();
            };
            reader.readAsText(file);
          }

          // Show security options section logic: scroll to security settings
          function showSecurityOptions() {
            const secSettings = document.getElementById("security-settings");
            if (secSettings) {
              secSettings.scrollIntoView({ behavior: "smooth" });
            }
          }

          document.addEventListener("DOMContentLoaded", () => {
            // Only add listeners if elements exist
            if (document.getElementById("new-password")) {
              document
                .getElementById("new-password")
                .addEventListener("input", (e) => {
                  const val = e.target.value;
                  const strength =
                    val.length > 8 ? 100 : val.length > 4 ? 50 : 20;
                  document.getElementById("pwd-strength").value = strength;
                });
            }
            if (document.getElementById("session-lock")) {
              document
                .getElementById("session-lock")
                .addEventListener("change", (e) => {
                  localStorage.setItem("sessionLock", e.target.checked);
                });
            }
            if (document.getElementById("trust-device")) {
              document
                .getElementById("trust-device")
                .addEventListener("change", (e) => {
                  localStorage.setItem("trustedDevice", e.target.checked);
                });
            }

            // Set last login and last pwd change fields
            if (document.getElementById("last-login"))
              document.getElementById("last-login").textContent =
                localStorage.getItem("lastLogin") || "N/A";
            if (document.getElementById("last-pwd-change"))
              document.getElementById("last-pwd-change").textContent =
                localStorage.getItem("lastPwdChange") || "N/A";
            localStorage.setItem("lastLogin", new Date().toLocaleString());
          });
          // --- End: Security Settings JS ---
        </script>
      </div>
    </div>

    <!-- Signup Page Template -->
    <template id="signup-template">
      <div
        class="max-w-3xl mx-auto bg-white dark:bg-gray-800 p-6 rounded shadow space-y-6"
      >
        <h2
          class="text-xl font-semibold mb-4 text-center text-gray-800 dark:text-white"
        >
          Sign Up
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Username</label
            >
            <input
              required
              type="text"
              placeholder="Username"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Password</label
            >
            <input
              required
              type="password"
              placeholder="Password"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >First Name</label
            >
            <input
              required
              type="text"
              placeholder="First Name"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Last Name</label
            >
            <input
              required
              type="text"
              placeholder="Last Name"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Email</label
            >
            <input
              required
              type="email"
              placeholder="Email"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Phone</label
            >
            <input
              required
              type="text"
              placeholder="Phone"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Bio (optional)</label
            >
            <input
              type="text"
              placeholder="Bio (optional)"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Gender</label
            >
            <select
              required
              id="signup-gender-select"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            >
              <option value="" disabled selected>Select Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="na">Prefer not to say</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Date of Birth</label
            >
            <input
              required
              type="date"
              placeholder="DOB"
              value="1990-01-01"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Nationality</label
            >
            <select
              required
              id="signup-nationality-select"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            >
              <option value="" disabled selected>Select Nationality</option>
              <option value="Indian">Indian</option>
              <option value="American">American</option>
              <option value="British">British</option>
              <option value="Canadian">Canadian</option>
              <option value="Australian">Australian</option>
              <option value="German">German</option>
              <option value="French">French</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Country</label
            >
            <input
              required
              type="text"
              placeholder="Country"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >City/State</label
            >
            <input
              required
              type="text"
              placeholder="City/State"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
          <div class="flex flex-col">
            <label class="text-sm text-gray-600 dark:text-gray-300"
              >Postal Code</label
            >
            <input
              required
              type="text"
              placeholder="Postal Code"
              class="signup-field p-2 rounded border border-gray-300 dark:bg-gray-700 dark:text-white"
            />
          </div>
        </div>
        <div class="flex justify-end">
          <button
            id="submit-signup"
            class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition pressed-effect"
          >
            Submit
          </button>
        </div>
      </div>
    </template>

    <!-- JavaScript -->
    <script>
      // --- Begin: Restrict site usage unless logged in ---
      document.addEventListener("DOMContentLoaded", () => {
        // Global login check
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        if (!isLoggedIn) {
          navigateToSection("home");
        } else {
          navigateToSection("home");
        }
        console.log("✅ DOMContentLoaded triggered");
        const inputBox = document.getElementById("input-box");
        const dateInput = document.getElementById("date-input");
        const timeInput = document.getElementById("time-input");
        const dosageInput = document.getElementById("dosage-input");
        const stockInput = document.getElementById("stock-input");
        const noteInput = document.getElementById("note-input");
        const frequencyInput = document.getElementById("frequency-input");

        // --- Begin: Load profile name from localStorage ---
        const savedName = localStorage.getItem("userName");
        if (savedName) {
          const profileInfo = document.getElementById("profile-info");
          const nameEl = document.getElementById("profile-name");
          profileInfo.classList.remove("hidden");
          nameEl.textContent = savedName;
        }
        // --- End: Load profile name from localStorage ---

        const listContainer = document.getElementById("lc");
        const addButton = document.getElementById("add-button");
        const historyList = document.getElementById("historyList");
        const themeToggle = document.getElementById("theme-toggle");
        const themeToggleMobile = document.getElementById(
          "theme-toggle-mobile"
        );
        const menuToggle = document.getElementById("menu-toggle");
        const mobileMenu = document.getElementById("mobile-menu");
        const html = document.documentElement;
        const dateWrapper = document.getElementById("date-wrapper");
        const weekdayWrapper = document.getElementById("weekday-wrapper");
        const weekdayInput = document.getElementById("weekday-input");

        const currentTheme = localStorage.getItem("theme");
        if (currentTheme === "dark") {
          html.classList.add("dark");
          themeToggle.textContent = "Light Mode";
          if (themeToggleMobile) themeToggleMobile.textContent = "Light Mode";
        } else {
          themeToggle.textContent = "Dark Mode";
          if (themeToggleMobile) themeToggleMobile.textContent = "Dark Mode";
        }

        // --- Begin: Add button login check and logic (REFACTORED for user-specific localStorage/sessionStorage) ---
        if (addButton) {
          addButton.addEventListener("click", () => {
            const isLoggedIn = localStorage.getItem("isLoggedIn");
            if (isLoggedIn !== "true") {
              alert("Please log in first");
              return;
            }

            // Get current user from sessionStorage
            const currentUser =
              sessionStorage.getItem("currentUser") ||
              localStorage.getItem("loggedInUser");
            if (!currentUser) {
              alert("User not found in session.");
              return;
            }
            const medsKey = `meds_${currentUser}`;

            // Proceed with add medicine logic as before:
            console.log("✅ Add button clicked");
            const medicine = inputBox.value.trim();
            let date = dateInput.value.trim();
            const time = timeInput.value.trim();
            const dose = dosageInput.valueAsNumber;
            const stock = stockInput.valueAsNumber;
            const note = noteInput.value.trim();
            const frequency = frequencyInput.value;

            // Frequency/date logic (calculate display date string)
            const today = new Date();
            if (frequency === "everyday") {
              date = today.toLocaleDateString("en-GB", {
                weekday: "short",
                day: "numeric",
                month: "short",
                year: "numeric",
              });
            } else if (frequency === "weekly") {
              // Find next selected weekday from today
              const selectedDay = weekdayInput.value;
              const weekdays = [
                "Sunday",
                "Monday",
                "Tuesday",
                "Wednesday",
                "Thursday",
                "Friday",
                "Saturday",
              ];
              let nextDate = new Date(today);
              const todayIndex = nextDate.getDay();
              const targetIndex = weekdays.indexOf(selectedDay);
              let daysUntilNext = (targetIndex - todayIndex + 7) % 7;
              if (daysUntilNext === 0) daysUntilNext = 7;
              nextDate.setDate(today.getDate() + daysUntilNext);
              date = nextDate.toLocaleDateString("en-GB", {
                weekday: "short",
                day: "numeric",
                month: "short",
                year: "numeric",
              });
            } else if (frequency === "alternate") {
              const nextDate = new Date(today);
              nextDate.setDate(today.getDate() + 2);
              date = nextDate.toLocaleDateString("en-GB", {
                weekday: "short",
                day: "numeric",
                month: "short",
                year: "numeric",
              });
            } else if (frequency === "monthly") {
              const nextDate = new Date(today);
              nextDate.setMonth(today.getMonth() + 1);
              date = nextDate.toLocaleDateString("en-GB", {
                weekday: "short",
                day: "numeric",
                month: "short",
                year: "numeric",
              });
            }

            // DEBUG: Raw values before validation
            console.log("Medicine raw input:", inputBox.value);
            console.log("Date raw input:", dateInput.value);
            console.log("Time raw input:", timeInput.value);
            console.log("Dosage raw input:", dosageInput.value);
            console.log("Stock raw input:", stockInput.value);

            console.log("Medicine:", medicine);
            console.log("Date:", date);
            console.log("Time:", time);
            console.log("Dose (raw):", dosageInput.value);
            console.log("Stock (raw):", stockInput.value);
            console.log("Dose:", dose);
            console.log("Stock:", stock);

            // Validation logic for required fields
            let dateRequired = true;
            if (frequency === "everyday" || frequency === "weekly") {
              dateRequired = false;
            }
            if (
              !medicine ||
              (!date && dateRequired) ||
              !time ||
              isNaN(dose) ||
              isNaN(stock) ||
              dose <= 0 ||
              stock <= 0
            ) {
              alert("Please fill in all required fields with valid values.");
              return;
            }

            const parsedDose = dose;
            const parsedStock = stock;

            const wrapper = document.createElement("div");
            wrapper.className =
              "relative swipe-wrapper overflow-hidden rounded";

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className =
              "absolute right-2 top-0 bottom-0 w-20 bg-red-600 text-white z-10 translate-x-full transition-transform duration-300";
            deleteBtn.addEventListener("click", () => wrapper.remove());

            const li = document.createElement("li");
            li.dataset.stock = parsedStock;
            li.dataset.dose = parsedDose;
            li.className =
              "p-2 bg-gray-100 dark:bg-gray-700 text-black dark:text-white transition-transform duration-300";
            li.innerHTML = `<strong>${medicine}</strong> — ${date} at ${time} | Stock: <span class="stock">${parsedStock}</span>${
              note ? " — Note: " + note : ""
            } — <span class="italic text-sm text-gray-600 dark:text-gray-300">(${frequency})</span>`;
            li.innerHTML += ` — <span class="italic text-sm text-gray-600 dark:text-gray-300 next-date">(Next: ${date})</span>`;
            li.innerHTML += `
            <div class="flex justify-end gap-2 mt-2 mr-4">
              <button class="taken-btn px-3 py-1 text-sm bg-green-500 text-white rounded hover:bg-green-600">Taken</button>
              <button class="snooze-btn px-3 py-1 text-sm bg-yellow-500 text-white rounded hover:bg-yellow-600">Snooze</button>
            </div>
          `;

            let startX = 0;
            let isDragging = false;

            li.addEventListener("touchstart", (e) => {
              startX = e.touches[0].clientX;
            });

            li.addEventListener("touchmove", (e) => {
              const deltaX = e.touches[0].clientX - startX;
              if (deltaX < -50) {
                li.style.transform = "translateX(-80px)";
                deleteBtn.style.transform = "translateX(0)";
              } else if (deltaX > 30) {
                li.style.transform = "translateX(0)";
                deleteBtn.style.transform = "translateX(100%)";
              }
            });

            li.addEventListener("mousedown", (e) => {
              isDragging = true;
              startX = e.clientX;
            });

            li.addEventListener("mousemove", (e) => {
              if (!isDragging) return;
              const deltaX = e.clientX - startX;
              if (deltaX < -50) {
                li.style.transform = "translateX(-80px)";
                deleteBtn.style.transform = "translateX(0)";
              } else if (deltaX > 30) {
                li.style.transform = "translateX(0)";
                deleteBtn.style.transform = "translateX(100%)";
              }
            });

            li.addEventListener("mouseup", () => {
              isDragging = false;
            });

            li.addEventListener("mouseleave", () => {
              isDragging = false;
            });

            wrapper.appendChild(deleteBtn);
            wrapper.appendChild(li);
            listContainer.appendChild(wrapper);

            // Save medicine to localStorage using user-specific key
            let meds = JSON.parse(localStorage.getItem(medsKey) || "[]");
            const newMedObj = {
              medicine,
              date,
              time,
              dose: parsedDose,
              stock: parsedStock,
              note,
              frequency,
            };
            meds.push(newMedObj);
            localStorage.setItem(medsKey, JSON.stringify(meds));

            // Add Taken and Snooze button logic
            li.querySelector(".taken-btn").addEventListener("click", (e) => {
              e.stopPropagation();
              if (!localStorage.getItem("isLoggedIn")) {
                alert("Please log in to track medicine intake.");
                return;
              }
              // Track last taken date and show confirmation only on repeated clicks for the same day
              const todayStr = new Date().toDateString();
              if (li.dataset.lastTakenDate === todayStr) {
                const confirmed = confirm(
                  "Do you want to add another 'Taken' entry?"
                );
                if (!confirmed) return;
              } else {
                li.dataset.lastTakenDate = todayStr;
              }
              let currStock = parseInt(li.dataset.stock);
              const dose = parseInt(li.dataset.dose);
              // Store previous stock and previous date before modifying
              const previousStock = currStock;
              const prevDate = li.querySelector(".next-date")?.textContent;
              const previousNextDate =
                li.querySelector(".next-date")?.textContent;

              if (currStock >= dose) {
                const newStock = currStock - dose;
                li.dataset.stock = newStock;
                li.querySelector(".stock").innerText = newStock;

                logToHistory({
                  date: new Date().toLocaleDateString(),
                  med: medicine,
                  dose: dose,
                  stockLeft: newStock,
                });

                // Update next date based on frequency
                const nextSpan = li.querySelector(".next-date");
                let referenceDate = new Date();

                if (nextSpan) {
                  const match =
                    nextSpan.textContent.match(/\(Next:\s*([^)]+)\)/);
                  if (match && match[1]) {
                    const parsed = Date.parse(match[1]);
                    if (!isNaN(parsed)) referenceDate = new Date(parsed);
                  }
                }

                function pushPrevDate(nextSpan, currentNext) {
                  let history = nextSpan.dataset.prevDates
                    ? JSON.parse(nextSpan.dataset.prevDates)
                    : [];
                  history.push(currentNext);
                  nextSpan.dataset.prevDates = JSON.stringify(history);
                }
                if (frequency === "everyday") {
                  const now = new Date();
                  now.setDate(now.getDate() + 1);
                  if (nextSpan) {
                    const currentNext = nextSpan.textContent.replace(
                      /\(Next:\s*([^)]+)\)/,
                      "$1"
                    );
                    const newNext = now.toLocaleDateString("en-GB", {
                      weekday: "short",
                      day: "numeric",
                      month: "short",
                      year: "numeric",
                    });
                    if (currentNext !== newNext) {
                      pushPrevDate(nextSpan, currentNext);
                      nextSpan.textContent = `(Next: ${newNext})`;
                    }
                  }
                }
                if (frequency === "alternate") {
                  const now = new Date();
                  now.setDate(now.getDate() + 2);
                  if (nextSpan) {
                    const currentNext = nextSpan.textContent.replace(
                      /\(Next:\s*([^)]+)\)/,
                      "$1"
                    );
                    const newNext = now.toLocaleDateString("en-GB", {
                      weekday: "short",
                      day: "numeric",
                      month: "short",
                      year: "numeric",
                    });
                    if (currentNext !== newNext) {
                      pushPrevDate(nextSpan, currentNext);
                      nextSpan.textContent = `(Next: ${newNext})`;
                    }
                  }
                }
                if (frequency === "weekly") {
                  const selectedDay = weekdayInput.value;
                  const daysOfWeek = [
                    "Sunday",
                    "Monday",
                    "Tuesday",
                    "Wednesday",
                    "Thursday",
                    "Friday",
                    "Saturday",
                  ];
                  const now = new Date();
                  const todayIndex = now.getDay();
                  const targetIndex = daysOfWeek.indexOf(selectedDay);
                  let daysToAdd = (targetIndex - todayIndex + 7) % 7;
                  if (daysToAdd === 0) daysToAdd = 7;
                  now.setDate(now.getDate() + daysToAdd);
                  if (nextSpan) {
                    const currentNext = nextSpan.textContent.replace(
                      /\(Next:\s*([^)]+)\)/,
                      "$1"
                    );
                    const newNext = now.toLocaleDateString("en-GB", {
                      weekday: "short",
                      day: "numeric",
                      month: "short",
                      year: "numeric",
                    });
                    if (currentNext !== newNext) {
                      pushPrevDate(nextSpan, currentNext);
                      nextSpan.textContent = `(Next: ${newNext})`;
                    }
                  }
                }
                if (frequency === "monthly") {
                  const now = new Date();
                  now.setMonth(now.getMonth() + 1);
                  if (nextSpan) {
                    const currentNext = nextSpan.textContent.replace(
                      /\(Next:\s*([^)]+)\)/,
                      "$1"
                    );
                    const newNext = now.toLocaleDateString("en-GB", {
                      weekday: "short",
                      day: "numeric",
                      month: "short",
                      year: "numeric",
                    });
                    if (currentNext !== newNext) {
                      pushPrevDate(nextSpan, currentNext);
                      nextSpan.textContent = `(Next: ${newNext})`;
                    }
                  }
                }

                // Always add undo button if not already present
                let undoBtn = li.querySelector(".undo-btn");
                if (!undoBtn) {
                  undoBtn = document.createElement("button");
                  undoBtn.textContent = "Undo";
                  undoBtn.className =
                    "undo-btn ml-2 px-2 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600";
                  li.querySelector(".taken-btn").after(undoBtn);
                }
                // Allow undo to add back the dose multiple times, capped by original stock
                undoBtn.onclick = () => {
                  const todayDateKey = new Date().toDateString();
                  let undoCount = parseInt(li.dataset.undoCount || "0");
                  if (li.dataset.lastTakenDate === todayDateKey) {
                    if (undoCount >= 1) {
                      const confirmUndo = confirm(
                        `You have reversed one dose already today. Do you want to undo another dose?`
                      );
                      if (!confirmUndo) return;
                    }
                  } else {
                    li.dataset.lastTakenDate = todayDateKey;
                    undoCount = 0;
                  }
                  undoCount++;
                  li.dataset.undoCount = undoCount.toString();

                  let currentDisplayedStock = parseInt(li.dataset.stock);
                  const restoredStock = Math.min(
                    currentDisplayedStock + dose,
                    stock
                  );
                  const nextSpan = li.querySelector(".next-date");

                  if (restoredStock > currentDisplayedStock) {
                    li.dataset.stock = restoredStock;
                    li.querySelector(".stock").innerText = restoredStock;
                    logToHistory({
                      date: new Date().toLocaleDateString(),
                      med: inputBox.value.trim(),
                      dose: dose,
                      stockLeft: restoredStock,
                    });

                    if (nextSpan && nextSpan.dataset.prevDates) {
                      let history = JSON.parse(nextSpan.dataset.prevDates);
                      if (history.length > 0) {
                        const last = history.pop();
                        const current = nextSpan.textContent.replace(
                          /\(Next:\s*([^)]+)\)/,
                          "$1"
                        );
                        if (last && current !== last) {
                          nextSpan.textContent = `(Next: ${last})`;
                          nextSpan.dataset.prevDates = JSON.stringify(history);
                        }
                        if (history.length === 0)
                          delete nextSpan.dataset.prevDates;
                      }
                    }

                    if (restoredStock === stock) {
                      undoBtn.remove();
                    }
                  } else {
                    alert(
                      "Stock is already at original level. Cannot undo further."
                    );
                  }
                };
              } else {
                alert("Not enough stock to take the dose.");
              }
            });

            li.querySelector(".snooze-btn").addEventListener("click", (e) => {
              e.stopPropagation();
              if (!localStorage.getItem("isLoggedIn")) {
                alert("Please log in to snooze reminders.");
                return;
              }
              const now = new Date();
              now.setMinutes(now.getMinutes() + 5);
              alert(
                `${medicine} snoozed for 5 more minutes (until ${now.toLocaleTimeString()})`
              );
            });

            inputBox.value = "";
            dateInput.value = "";
            timeInput.value = "";
            dosageInput.value = "";
            stockInput.value = "";
            noteInput.value = "";
          });
        }
        // --- End: Add button login check and logic (REFACTORED for user-specific localStorage/sessionStorage) ---

        // Frequency change logic for showing/hiding date/weekday
        frequencyInput.addEventListener("change", () => {
          const val = frequencyInput.value;
          if (val === "everyday") {
            dateWrapper.style.display = "none";
            weekdayWrapper.style.display = "none";
          } else if (val === "weekly") {
            dateWrapper.style.display = "none";
            weekdayWrapper.style.display = "block";
          } else {
            dateWrapper.style.display = "block";
            weekdayWrapper.style.display = "none";
          }
        });

        // Save history using per-user key
        function logToHistory({ date, med, dose, stockLeft }) {
          const currentUser =
            sessionStorage.getItem("currentUser") ||
            localStorage.getItem("loggedInUser");
          if (!currentUser) return;
          const historyKey = `history_${currentUser}`;
          let historyData = JSON.parse(
            localStorage.getItem(historyKey) || "[]"
          );
          historyData.unshift({
            date: date,
            med: med,
            dose: dose,
            stockLeft: stockLeft,
          });
          localStorage.setItem(historyKey, JSON.stringify(historyData));
        }

        themeToggle.addEventListener("click", () => {
          html.classList.toggle("dark");
          const isDark = html.classList.contains("dark");
          localStorage.setItem("theme", isDark ? "dark" : "light");
          themeToggle.textContent = isDark ? "Light Mode" : "Dark Mode";
          if (themeToggleMobile)
            themeToggleMobile.textContent = isDark ? "Light Mode" : "Dark Mode";
        });

        if (themeToggleMobile) {
          themeToggleMobile.addEventListener("click", () => {
            html.classList.toggle("dark");
            const isDark = html.classList.contains("dark");
            localStorage.setItem("theme", isDark ? "dark" : "light");
            themeToggle.textContent = isDark ? "Light Mode" : "Dark Mode";
            themeToggleMobile.textContent = isDark ? "Light Mode" : "Dark Mode";
          });
        }

        if (menuToggle && mobileMenu) {
          menuToggle.addEventListener("click", () => {
            mobileMenu.classList.toggle("hidden");
          });
        }

        if (historyList) {
          const currentUser =
            sessionStorage.getItem("currentUser") ||
            localStorage.getItem("loggedInUser");
          const historyKey = `history_${currentUser}`;
          const userHistory = JSON.parse(
            localStorage.getItem(historyKey) || "[]"
          );
          userHistory.forEach(({ date, med, dose, stockLeft }, index) => {
            const row = document.createElement("tr");
            row.className = "text-gray-800 dark:text-white";
            row.innerHTML = `
              <td class="px-4 py-2">
                <input type="checkbox" class="delete-checkbox hidden" data-index="${index}" />
              </td>
              <td class="px-4 py-2">${date}</td>
              <td class="px-4 py-2">${med}</td>
              <td class="px-4 py-2">${dose}</td>
              <td class="px-4 py-2">${stockLeft}</td>
            `;
            historyList.appendChild(row);
          });
        }
      });
      // Navigation function for switching sections (updated to always refresh history)
      function navigateToSection(id) {
        const isLoggedIn = localStorage.getItem("isLoggedIn");
        const sections = ["home", "history", "settings", "signup-page"];
        const unrestrictedSections = ["home", "signup-page", "settings"];

        if (!isLoggedIn && !unrestrictedSections.includes(id)) {
          alert("Please log in or sign up to use this feature.");
          return;
        }

        if (id === "history") {
          const historyList = document.getElementById("historyList");
          historyList.innerHTML = "";
          const currentUser =
            sessionStorage.getItem("currentUser") ||
            localStorage.getItem("loggedInUser");
          const historyKey = `history_${currentUser}`;
          const userHistory = JSON.parse(
            localStorage.getItem(historyKey) || "[]"
          );
          userHistory.forEach(({ date, med, dose, stockLeft }, index) => {
            const row = document.createElement("tr");
            row.className = "text-gray-800 dark:text-white";
            row.innerHTML = `
              <td class="px-4 py-2">
                <input type="checkbox" class="delete-checkbox hidden" data-index="${index}" />
              </td>
              <td class="px-4 py-2">${date}</td>
              <td class="px-4 py-2">${med}</td>
              <td class="px-4 py-2">${dose}</td>
              <td class="px-4 py-2">${stockLeft}</td>
            `;
            historyList.appendChild(row);
          });
        }

        sections.forEach((section) => {
          const el = document.getElementById(section);
          if (el) {
            if (section === id) {
              el.classList.remove("hidden");
            } else {
              el.classList.add("hidden");
            }
          }
        });

        if (typeof mobileMenu !== "undefined" && mobileMenu) {
          mobileMenu.classList.add("hidden");
        }
      }
      // --- Begin: Profile Image Upload and LocalStorage Preview (user-specific) ---
      (function () {
        const currentUser =
          sessionStorage.getItem("currentUser") ||
          localStorage.getItem("loggedInUser");
        const savedImg = currentUser
          ? localStorage.getItem(`profilePicture_${currentUser}`)
          : null;
        const picEl = document.getElementById("profile-pic");
        if (picEl && savedImg) {
          picEl.src = savedImg;
        }

        // Handle profile image upload and save to localStorage per user
        const fileInput = document.getElementById("profile-image-upload");
        if (fileInput && picEl) {
          fileInput.addEventListener("change", function () {
            const file = fileInput.files[0];
            if (file && file.type.startsWith("image/")) {
              const reader = new FileReader();
              reader.onload = function (e) {
                const imageBase64 = e.target.result;
                if (currentUser) {
                  localStorage.setItem(
                    `profilePicture_${currentUser}`,
                    imageBase64
                  );
                  picEl.src = imageBase64;
                }
              };
              reader.readAsDataURL(file);
            }
          });

          picEl.addEventListener("click", () => fileInput.click());
        }
      })();
      // --- End: Profile Image Upload and LocalStorage Preview (user-specific) ---
    </script>
    <script>
      document.getElementById("save-profile")?.addEventListener("click", () => {
        alert("Profile changes saved!");

        const firstName = document.querySelector('input[placeholder="First Name"]').value.trim();
        const lastName = document.querySelector('input[placeholder="Last Name"]').value.trim();
        const fullName = `${firstName} ${lastName}`.trim();

        const currentUser = sessionStorage.getItem("currentUser") || localStorage.getItem("loggedInUser");
        const allUsers = JSON.parse(localStorage.getItem("allUsers") || "{}");
        const user = allUsers[currentUser] || {};

        // Update user object with new values
        user.firstname = firstName;
        user.lastname = lastName;
        user.email = document.querySelector('input[placeholder="Email"]').value.trim();
        user.phone = document.querySelector('input[placeholder="Phone"]').value.trim();
        user.bio = document.querySelector('input[placeholder="Bio (optional)"]').value.trim();
        user.dob = document.querySelector('#settings-content input[type="date"]')?.value.trim();
        user.gender = document.getElementById("gender-select")?.value;
        user.nationality = document.getElementById("nationality-select")?.value;
        user.country = document.querySelector('input[placeholder="Country"]').value.trim();
        user.city = document.querySelector('input[placeholder="City/State"]').value.trim();
        user.postalCode = document.querySelector('input[placeholder="Postal Code"]').value.trim();

        // Save updated user profile back to localStorage
        allUsers[currentUser] = user;
        localStorage.setItem("allUsers", JSON.stringify(allUsers));

        // Update display name at top
        const profileInfo = document.getElementById("profile-info");
        const nameEl = document.getElementById("profile-name");
        if (fullName) {
          nameEl.textContent = fullName;
          profileInfo.classList.remove("hidden");
          localStorage.setItem("userName", fullName);
        }

        // Disable fields after save
        document.querySelectorAll("#settings input, #settings select").forEach((el) => {
          el.setAttribute("disabled", true);
        });
      });
    </script>
    <script>
      const editBtn = document.querySelector("button.bg-blue-600");
      if (editBtn) {
        const storedUser = JSON.parse(
          localStorage.getItem("userProfile") || "{}"
        );
        if (
          storedUser.username &&
          localStorage.getItem("isLoggedIn") === "true"
        ) {
          editBtn.addEventListener("click", () => {
            document
              .querySelectorAll("#settings input, #settings select")
              .forEach((el) => {
                el.removeAttribute("disabled");
              });
          });
        } else {
          editBtn.addEventListener("click", () => {
            alert("You must sign up and log in to edit your profile.");
          });
        }
      }
    </script>
  </body>
</html>

<script>
  // --- Begin: Login/Signup simulation logic ---
  document.addEventListener("DOMContentLoaded", () => {
    const loginBtn = document.getElementById("login-btn");
    const signUpBtn = document.getElementById("sign-up-btn");
    const logoutBtn = document.getElementById("logout-btn");

    function fillFormFields(data) {
      const fields = {
        "First Name": data.firstname,
        "Last Name": data.lastname,
        Email: data.email,
        Phone: data.phone,
        "Bio (optional)": data.bio,
        Country: data.country,
        "City/State": data.city || data.citystate,
        "Postal Code": data.postalCode || data.postalcode,
      };

      for (const [placeholder, value] of Object.entries(fields)) {
        const input = document.querySelector(
          `input[placeholder="${placeholder}"]`
        );
        if (input && value) input.value = value;
      }
      // Fill username if present
      if (data.username) {
        const input = document.querySelector('input[placeholder="Username"]');
        if (input) input.value = data.username;
      }
      // Do NOT autofill password for security

      if (data.gender)
        document.getElementById("gender-select").value = data.gender;
      // Insert nationality select logic after gender select
      const nationalitySelect = document.getElementById("nationality-select");
      if (nationalitySelect && data.nationality) {
        nationalitySelect.value = data.nationality;
      }
      // Fill DOB (date of birth)
      if (data.dob) {
        // Find the correct date input in the settings form
        const settingsDateInput = document.querySelector(
          '#settings-content input[type="date"]'
        );
        if (settingsDateInput) settingsDateInput.value = data.dob;
      }
      // Fill City/State (settings form)
      if (data.city || data.citystate) {
        const cityInput = document.querySelector(
          '#settings input[placeholder="City/State"]'
        );
        if (cityInput) cityInput.value = data.city || data.citystate;
      }
      // Fill Postal Code (settings form)
      if (data.postalCode || data.postalcode) {
        const postalInput = document.querySelector(
          '#settings input[placeholder="Postal Code"]'
        );
        if (postalInput) postalInput.value = data.postalCode || data.postalcode;
      }
      // (Old code handled nationality select here, now handled above)

      const fullName = `${data.firstname || data.firstName || ""} ${
        data.lastname || data.lastName || ""
      }`.trim();
      if (fullName) {
        document.getElementById("profile-name").textContent = fullName;
        document.getElementById("profile-info").classList.remove("hidden");
        localStorage.setItem("userName", fullName);
      }
    }

    if (loginBtn) {
      loginBtn.addEventListener("click", handleLogin);
    }

    // Modern login form handler (replaces old prompt-based login)
    function handleLogin() {
      // Display the login content section
      const settingsContent = document.getElementById("settings-content") || document.getElementById("main-content");
      if (settingsContent) {
        settingsContent.innerHTML = `
          <div class="p-6 space-y-4">
            <h2 class="text-xl font-semibold">Login</h2>
            <form id="login-form" class="space-y-4">
              <div>
                <label for="login-username" class="block text-sm font-medium">Username</label>
                <input type="text" id="login-username" required class="mt-1 block w-full px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-black dark:text-white">
              </div>
              <div>
                <label for="login-password" class="block text-sm font-medium">Password</label>
                <input type="password" id="login-password" required class="mt-1 block w-full px-3 py-2 border rounded-md bg-white dark:bg-gray-700 text-black dark:text-white">
              </div>
              <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Login</button>
            </form>
          </div>
        `;
      }

      highlightButton(document.getElementById("login-btn"));

      // Handle form submission
      document.getElementById("login-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const username = document.getElementById("login-username").value.trim();
        const password = document.getElementById("login-password").value.trim();

        if (!username || !password) {
          alert("Please fill in all fields.");
          return;
        }

        // Use allUsers object for authentication
        const allUsers = JSON.parse(localStorage.getItem("allUsers") || "{}");
        const user = allUsers[username];
        if (!user || user.password !== password) {
          alert("Invalid username or password.");
          return;
        }

        // Set login/session flags
        sessionStorage.setItem("loggedInUser", JSON.stringify(user));
        sessionStorage.setItem("currentUser", username);
        localStorage.setItem("isLoggedIn", "true");
        localStorage.setItem("loggedInUser", username);

        // Save/display user name after successful login
        const fullName =
          (user.firstname || user.firstName || "") +
          " " +
          (user.lastname || user.lastName || "");
        if (fullName.trim()) {
          localStorage.setItem("userName", fullName.trim());
          const profileInfo = document.getElementById("profile-info");
          const nameEl = document.getElementById("profile-name");
          if (profileInfo && nameEl) {
            nameEl.textContent = fullName.trim();
            profileInfo.classList.remove("hidden");
          }
        }
        alert("Login successful!");
        // After login, show profile, fill fields, highlight button
        setTimeout(() => navigateToSection("home"), 100); // Ensures view switches properly
        fillFormFields(user);
        loadSettingsContent("profile");
        setTimeout(() => fillFormFields(user), 150); // Ensure DOM is ready
        setTimeout(() => fillFormFields(user), 300);
        highlightButton(document.getElementById("my-profile-btn"));
      });
    }

    // Update signUpBtn event listener to show signup page
    if (signUpBtn) {
      signUpBtn.addEventListener("click", function () {
        const settingsContainer = document.getElementById("settings");
        const settingsContent = document.getElementById("settings-content");

        if (settingsContainer) {
          navigateToSection("settings");
          settingsContainer.style.display = "block";
        }

        if (settingsContent) {
          settingsContent.innerHTML = document.getElementById("signup-template").innerHTML;
        }

        highlightButton(this);
      });
    }

    // Logout handler
    if (logoutBtn) {
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("isLoggedIn");
        localStorage.removeItem("userName");
        document.getElementById("profile-info")?.classList.add("hidden");
        document.getElementById("profile-name").textContent = "";
        document
          .querySelectorAll("#settings input, #settings select")
          .forEach((el) => {
            el.value = "";
          });
        alert("You have been logged out.");
        navigateToSection("home");
      });
    }

    // Signup page submit handler (REFACTORED)
    document.addEventListener("click", function (e) {
      if (e.target && e.target.id === "submit-signup") {
        e.preventDefault();
        const user = {
          username: document
            .querySelector('input.signup-field[placeholder="Username"]')
            ?.value.trim(),
          password: document
            .querySelector('input.signup-field[placeholder="Password"]')
            ?.value.trim(),
          firstname: document
            .querySelector('input.signup-field[placeholder="First Name"]')
            ?.value.trim(),
          lastname: document
            .querySelector('input.signup-field[placeholder="Last Name"]')
            ?.value.trim(),
          email: document
            .querySelector('input.signup-field[placeholder="Email"]')
            ?.value.trim(),
          phone: document
            .querySelector('input.signup-field[placeholder="Phone"]')
            ?.value.trim(),
          gender: document.getElementById("signup-gender-select")?.value,
          dob: document
            .querySelector('input.signup-field[type="date"]')
            ?.value.trim(),
          nationality: document.getElementById("signup-nationality-select")
            ?.value,
          country: document
            .querySelector('input.signup-field[placeholder="Country"]')
            ?.value.trim(),
          city: document
            .querySelector('input.signup-field[placeholder="City/State"]')
            ?.value.trim(),
          postalCode: document
            .querySelector('input.signup-field[placeholder="Postal Code"]')
            ?.value.trim(),
          bio: document
            .querySelector('input.signup-field[placeholder="Bio (optional)"]')
            ?.value.trim(),
        };

        const requiredFields = [
          "username",
          "password",
          "firstname",
          "lastname",
          "email",
          "phone",
          "gender",
          "dob",
          "nationality",
          "country",
          "city",
          "postalCode",
        ];

        const missingFields = requiredFields.filter((key) => !user[key]);
        if (missingFields.length > 0) {
          alert("Please fill all details.");
          return;
        }

        const allUsers = JSON.parse(localStorage.getItem("allUsers") || "{}");
        allUsers[user.username] = user;
        localStorage.setItem("allUsers", JSON.stringify(allUsers));

        // Save the new user data logic here (already handled above)
        alert("Thank you for signing up! You can now log in.");
        // After signup, switch to settings section and show login view
        navigateToSection("settings");
        loadSettingsContent("login");
        fillFormFields(user);

        // Replace DOM hide/show logic with:
        const settingsContent = document.getElementById("settings-content");
        if (settingsContent) {
          // settingsContent.innerHTML = document.getElementById("profile-template").innerHTML;
        }

        // Remove active class from all sidebar/settings buttons and rehighlight the profile button
        document.querySelectorAll(".settings-option button, #settings aside button").forEach(btn => btn.classList.remove("active", "bg-blue-100", "text-blue-700"));
        // highlightButton(document.getElementById("my-profile-btn"));
      }
    });
  });
  // --- End: Login/Signup simulation logic ---
</script>

<script>
  document
    .getElementById("toggle-delete-mode")
    ?.addEventListener("click", () => {
      const checkboxes = document.querySelectorAll(".delete-checkbox");
      if (!checkboxes.length) return;
      const deleting = checkboxes[0].classList.contains("hidden") === false;

      checkboxes.forEach((cb) => cb.classList.toggle("hidden"));

      if (deleting) {
        const selectedIndexes = Array.from(checkboxes)
          .filter((cb) => cb.checked)
          .map((cb) => parseInt(cb.dataset.index));

        if (selectedIndexes.length === 0) {
          alert("Please select at least one entry to delete.");
          return;
        }

        const currentUser =
          sessionStorage.getItem("currentUser") ||
          localStorage.getItem("loggedInUser");
        const historyKey = `history_${currentUser}`;
        const userHistory = JSON.parse(
          localStorage.getItem(historyKey) || "[]"
        );

        const updatedHistory = userHistory.filter(
          (_, index) => !selectedIndexes.includes(index)
        );
        localStorage.setItem(historyKey, JSON.stringify(updatedHistory));
        location.reload();
      }
    });



</script>